generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  OPERATOR
  MECHANIC
}

enum TruckStatus {
  ACTIVE
  INACTIVE
  OUT_OF_SERVICE
}

enum WorkOrderStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model User {
  id                 String        @id @default(cuid())
  name               String
  email              String        @unique
  role               UserRole      @default(OPERATOR)
  createdAt          DateTime      @default(now())
  yardEntries        YardEntry[]
  assignedWorkOrders WorkOrder[]   @relation("AssignedWorkOrders")
  completedServices  ServiceHistory[]
  auditLogs          AuditLog[]
}

model Truck {
  id                 String                 @id @default(cuid())
  truckNumber        String                 @unique
  brand              String
  model              String
  year               Int
  currentOdometer    Int                    @default(0)
  status             TruckStatus            @default(ACTIVE)
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt
  yardEntries        YardEntry[]
  workOrders         WorkOrder[]
  serviceHistory     ServiceHistory[]
  maintenanceStates  TruckMaintenanceState[]

  @@index([truckNumber])
  @@index([status])
}

model YardEntry {
  id           String   @id @default(cuid())
  truckId      String
  datetime     DateTime @default(now())
  odometer     Int
  computedDelta Int     @default(0)
  recordedById String
  notes        String?
  photoUrl     String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  truck       Truck      @relation(fields: [truckId], references: [id], onDelete: Cascade)
  recordedBy  User       @relation(fields: [recordedById], references: [id])
  workOrders  WorkOrder[]

  @@index([truckId, datetime])
  @@index([truckId, odometer])
}

model MaintenanceType {
  id                 String                 @id @default(cuid())
  name               String                 @unique
  intervalMiles      Int
  warningBeforeMiles Int                    @default(50)
  isActive           Boolean                @default(true)
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt

  workOrders        WorkOrder[]
  serviceHistory    ServiceHistory[]
  maintenanceStates TruckMaintenanceState[]

  @@index([isActive])
}

model TruckMaintenanceState {
  id                 String   @id @default(cuid())
  truckId            String
  maintenanceTypeId  String
  lastServiceOdometer Int     @default(0)
  lastServiceAt      DateTime?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  truck            Truck            @relation(fields: [truckId], references: [id], onDelete: Cascade)
  maintenanceType  MaintenanceType  @relation(fields: [maintenanceTypeId], references: [id], onDelete: Cascade)

  @@unique([truckId, maintenanceTypeId])
  @@index([truckId])
  @@index([maintenanceTypeId])
}

model WorkOrder {
  id                 String          @id @default(cuid())
  serialNumber       Int             @default(autoincrement()) @unique
  workorderNumber    String          @unique
  truckId            String
  maintenanceTypeId  String
  status             WorkOrderStatus @default(PENDING)
  createdAt          DateTime        @default(now())
  dueAtOdometer      Int
  completedAt        DateTime?
  assignedToId       String?
  createdFromEntryId String?
  autoGenerated      Boolean         @default(true)

  truck            Truck            @relation(fields: [truckId], references: [id], onDelete: Cascade)
  maintenanceType  MaintenanceType  @relation(fields: [maintenanceTypeId], references: [id], onDelete: Restrict)
  assignedTo       User?            @relation("AssignedWorkOrders", fields: [assignedToId], references: [id])
  createdFromEntry YardEntry?       @relation(fields: [createdFromEntryId], references: [id], onDelete: SetNull)
  serviceHistory   ServiceHistory?

  @@index([truckId, maintenanceTypeId, status])
  @@index([status, createdAt])
}

model ServiceHistory {
  id                 String   @id @default(cuid())
  truckId            String
  maintenanceTypeId  String
  workorderId        String   @unique
  performedAt        DateTime @default(now())
  odometerAtService  Int
  performedById      String
  notes              String?
  attachmentUrl      String?

  truck            Truck            @relation(fields: [truckId], references: [id], onDelete: Cascade)
  maintenanceType  MaintenanceType  @relation(fields: [maintenanceTypeId], references: [id], onDelete: Restrict)
  workOrder        WorkOrder        @relation(fields: [workorderId], references: [id], onDelete: Cascade)
  performedBy      User             @relation(fields: [performedById], references: [id])

  @@index([truckId, performedAt])
  @@index([maintenanceTypeId, performedAt])
}

model AuditLog {
  id         String   @id @default(cuid())
  entityType String
  entityId   String
  oldValue   Json
  newValue   Json
  changedById String
  reason     String
  timestamp  DateTime @default(now())

  changedBy User @relation(fields: [changedById], references: [id])

  @@index([entityType, entityId])
  @@index([timestamp])
}
